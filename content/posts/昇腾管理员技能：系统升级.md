---
title: 昇腾管理员技能：系统升级
summary: 怎样为华为昇腾服务器升级固件和工具包
date: 2024-03-22
tags: ["服务器", "Ascend"]
draft: false
---
## 起因
前段时间实验室租用了两台昇腾 910B 服务器，由于一开始的测试环节安排了我参与，现在也就稀里糊涂地成了服务器的管理员。

昇腾生态主要涉及到 CANN，MindSpore，MindFormers 等工具和包，关于这些概念之间的关系和梳理，我之前做过一次组内汇报，有时间整理成博文再发。

这些工具在不断迭代，新版本依赖新固件。因此想使用新版本（会解决一些老版本的 bug），就得不断更新固件。
## 梳理
### 参考与整理
参考文档主要包括：
- [物理机升级固件](https://www.hiascend.com/document/detail/zh/quick-installation/23.0.RC3/quickinstg_train/800_9000/quickinstg_800_9000_006.html)
- [物理机升级CANN](https://www.hiascend.com/document/detail/zh/quick-installation/23.0.RC3/quickinstg_train/800_9000/quickinstg_800_9000_008.html)
- 之前和昇腾方面工作人员对接时得到的文档（找不到了）

总结下来流程就是：下载指定安装包、卸载老版本、安装新版本。并不复杂。

需要的安装包包括：
- 固件
- 驱动
- cann
- naee
- Kernels

naee 和 kernels 用在哪里我并不确定，但机器上之前就装过，为了稳妥，仍然安装。
### 资源下载
上面软件包可以去下面两个网址下载：
- 固件和驱动： https://www.hiascend.com/hardware/firmware-drivers/community
- CANN 相关资源： https://www.hiascend.com/developer/download/community/result
选择你的机器型号和需要的版本，下载 `run` 后缀的文件。
### 安装过程
其实下载下来的文件都是 shell 脚本，对于每一个 run 文件，你需要：
1. 添加执行权限
2. 运行，并给它必要的参数
具体命令可以在本节开头的官方文档找到命令，我就不抄一遍了。也可以参考下一节中我编写的脚本。
## 自动化
枯燥的事情交给程序，我把流程写在了一个脚本里，非常简单没有考虑太多条件判断和异常处理，仅作辅助备忘的用途。
```shell
#!/usr/bin/bash
# you should ensure the necessary software packages have been downloaded.
# enter working path
pushd "$(dirname "$0")" > /dev/null
# add Executive authority
chmod o+x *.run
######################### 固件 #########################
# 升级NPU固件驱动时，需按照“固件 > 驱动”的顺序升级
# 执行安装，自动升级
./Ascend-hdk-910-npu-firmware_7.1.0.3.220.run --full --quiet
./Ascend-hdk-910-npu-driver_23.0.0_linux-aarch64.run --full --install-for-all --quiet
######################### 工具包 #######################
# 按顺序卸载和安装,其实按理说直接安装应该也能自动升级，不需要进行卸载
# uninstall old version
./Ascend-cann-kernels-910b_7.0.0_linux.run --uninstall
./Ascend-cann-nnae_7.0.0_linux-aarch64.run --uninstall
./Ascend-cann-toolkit_7.0.0_linux-aarch64.run --uninstall
# install new version
./Ascend-cann-toolkit_7.0.0_linux-aarch64.run --install --install-for-all --quiet 
./Ascend-cann-nnae_7.0.0_linux-aarch64.run --install --install-for-all --quiet 
./Ascend-cann-kernels-910b_7.0.0_linux.run --install --install-for-all --quiet 
########################################################
# exit working path
popd > > /dev/null
echo You should restart system.
```
将下载下来的文件与这个脚本放在一个目录下，给脚本执行权限，然后执行即可。